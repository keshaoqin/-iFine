<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>精力健康评估测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .section-title {
            font-size: 1.5rem;
            color: #4a5568;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .question {
            margin-bottom: 25px;
        }

        .question-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .question-type {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 10px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            border-color: #667eea;
            background-color: #f7fafc;
        }

        .option.selected {
            border-color: #667eea;
            background-color: #edf2f7;
        }

        .option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f5f5f5;
            border-color: #d1d5db;
        }

        .option.disabled input {
            cursor: not-allowed;
        }

        .option input {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .basic-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #4a5568;
        }

        .input-group input, .input-group select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .hidden {
            display: none;
        }

        .results {
            text-align: center;
        }

        .overall-score {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .health-level {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
        }

        .pillar-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .pillar-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .pillar-name {
            font-weight: 600;
            margin-bottom: 10px;
            color: #4a5568;
        }

        .pillar-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .recommendations {
            text-align: left;
            margin-top: 30px;
        }

        .recommendation-item {
            background: #f7fafc;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .recommendation-title {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .basic-info {
                grid-template-columns: 1fr;
            }
            
            .navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>精力健康评估测试</h1>
            <p>全面评估您的睡眠、运动、营养、肠道健康和压力管理状况</p>
        </div>

        <!-- 进度条 -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- 介绍页面 -->
        <div class="card" id="introPage">
            <h2 class="section-title">欢迎参加精力健康评估测试</h2>
            <div style="text-align: left; line-height: 1.8; font-size: 1.1rem; color: #4a5568;">
                <p style="margin-bottom: 20px;">本测试将从<strong>五个核心维度</strong>全面评估您的精力健康状况：</p>
                <ul style="margin-left: 20px; margin-bottom: 25px;">
                    <li style="margin-bottom: 8px;"><strong>睡眠支柱</strong> - 评估您的睡眠质量和作息规律</li>
                    <li style="margin-bottom: 8px;"><strong>运动支柱</strong> - 了解您的运动习惯和身体活动水平</li>
                    <li style="margin-bottom: 8px;"><strong>营养支柱</strong> - 分析您的饮食模式和营养状况</li>
                    <li style="margin-bottom: 8px;"><strong>肠道健康支柱</strong> - 检查您的消化系统健康状态</li>
                    <li style="margin-bottom: 8px;"><strong>压力与情绪支柱</strong> - 评估您的压力管理和情绪调节能力</li>
                </ul>
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; border-left: 5px solid #667eea; margin-bottom: 25px;">
                    <p style="margin-bottom: 10px;"><strong>测试说明：</strong></p>
                    <p style="margin-bottom: 8px;">• 测试大约需要 <strong>3-5分钟</strong> 完成</p>
                    <p style="margin-bottom: 8px;">• 请根据您<strong>最近一个月</strong>的真实情况作答</p>
                    <p style="margin-bottom: 8px;">• 所有信息将严格保密，仅用于生成个性化健康建议</p>
                    <p>• 完成后您将获得详细的健康评估报告和改善建议</p>
                </div>
                <p style="text-align: center; color: #718096; font-style: italic;">准备好开始您的健康之旅了吗？</p>
            </div>
            <div class="navigation" style="margin-top: 30px;">
                <div></div>
                <button class="btn" onclick="startTest()">开始测试</button>
            </div>
        </div>

        <!-- 基本信息页面 -->
         <div class="card hidden" id="basicInfoPage">
            <h2 class="section-title">基本信息</h2>
            <div class="basic-info">
                <div class="input-group">
                    <label for="birth-year">出生年份</label>
                    <select id="birth-year">
                        <option value="">请选择出生年份</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="gender">性别</label>
                    <select id="gender">
                        <option value="">请选择</option>
                        <option value="male">男</option>
                        <option value="female">女</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="province">省份</label>
                    <select id="province" onchange="updateCities()">
                        <option value="">请选择省份</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="city">城市</label>
                    <select id="city">
                        <option value="">请先选择省份</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="occupation">职业状态</label>
                    <select id="occupation">
                        <option value="">请选择</option>
                        <option value="full-time-office">全职工作（固定通勤）</option>
                        <option value="full-time-remote">全职工作（灵活/居家办公）</option>
                        <option value="freelance">自由职业/自主创业</option>
                        <option value="full-time-mom">全职妈妈</option>
                        <option value="unemployed">暂未工作</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="marital-status">婚姻与家庭状况</label>
                    <select id="marital-status">
                        <option value="">请选择</option>
                        <option value="single">未婚</option>
                        <option value="married-no-children">已婚未育</option>
                        <option value="married-preschool">已婚，有学龄前子女 (0-6岁)</option>
                        <option value="married-school-age">已婚，有学龄期子女 (7岁及以上)</option>
                        <option value="married-both">已婚，有学龄前与学龄期子女</option>
                    </select>
                </div>
            </div>
            <div class="navigation">
                <div></div>
                <button class="btn" onclick="nextPage()">开始测试</button>
            </div>
        </div>

        <!-- 问卷页面 -->
        <div class="card hidden" id="questionnairePage">
            <h2 class="section-title" id="currentSectionTitle">睡眠支柱</h2>
            <div id="questionContainer"></div>
            <div class="navigation">
                <button class="btn" id="prevBtn" onclick="prevQuestion()" style="display: none;">上一题</button>
                <button class="btn" id="nextBtn" onclick="nextQuestion()">下一题</button>
            </div>
        </div>

        <!-- 结果页面 -->
        <div class="card hidden" id="resultsPage">
            <h2 class="section-title">您的健康评估结果</h2>
            <div class="results">
                <div class="overall-score" id="overallScore">85%</div>
                <div class="health-level" id="healthLevel">状态良好</div>
                
                <!-- 雷达图可视化 -->
                <div class="chart-container" style="margin: 30px 0; text-align: center;">
                    <h3 style="margin-bottom: 20px; color: #4a5568;">五维健康雷达图</h3>
                    <canvas id="healthRadarChart" width="400" height="400" style="max-width: 400px; max-height: 400px; margin: 0 auto;"></canvas>
                </div>
                
                <div class="pillar-scores" id="pillarScores"></div>
                
                <div class="recommendations" id="recommendations"></div>
                
                <div class="export-buttons">
                    <button class="btn" onclick="exportToPDF()">导出PDF报告</button>
                    <button class="btn" onclick="exportToJSON()">导出数据</button>
                    <button class="btn" onclick="restartTest()">重新测试</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // 问卷数据结构 - 严格按照测试报告.md中的题目
        const questionnaire = {
            sleep: {
                title: "睡眠支柱",
                intro: "睡眠是身心修复的根本。接下来的问题将帮助我们一同探寻影响您睡眠质量的关键环节。",
                questions: [
                    {
                        id: "Q6",
                        type: "single",
                        category: "standard",
                        text: "您通常的睡眠节律（上床睡觉和起床的时间）是怎样的？",
                        options: [
                            { text: "非常规律：工作日与周末的作息时间差异在1小时以内，形成了固定的生物钟。", score: 4 },
                            { text: "基本规律：工作日作息规律，但周末会晚睡晚起，与工作日差异在1-2小时。", score: 3 },
                            { text: "不太规律：上床和起床时间经常变动，没有形成固定的睡眠节奏。", score: 2 },
                            { text: "严重不规律：几乎没有固定的作息，经常因工作或娱乐而\"报复性熬夜\"。", score: 1 }
                        ]
                    },
                    {
                        id: "Q7",
                        type: "single",
                        category: "standard",
                        text: "在关闭光源、准备入睡后，您通常需要多久才能真正睡着？",
                        options: [
                            { text: "快速入睡：几乎总是在15分钟内就能轻松睡着。", score: 4 },
                            { text: "正常入睡：通常需要15-30分钟左右才能入睡。", score: 3 },
                            { text: "入睡困难：经常需要30-60分钟，有时会感到焦虑或转身。", score: 2 },
                            { text: "严重入睡困难：绝大多数时候都需要1小时以上才能入睡。", score: 1 }
                        ]
                    },
                    {
                        id: "Q8",
                        type: "single",
                        category: "standard",
                        text: "在夜间，您的睡眠连续性如何？",
                        options: [
                            { text: "非常连续：几乎总是一觉到天亮，没有夜醒的困扰。", score: 4 },
                            { text: "偶有中断：偶尔会醒来1次（如上厕所），但能立刻重新入睡。", score: 3 },
                            { text: "经常中断：每周都有数晚会醒来2次或以上，或者醒来后需要一些时间才能再次入睡。", score: 2 },
                            { text: "严重碎片化：几乎每晚都会醒来多次，或有长时间的清醒时段，感觉整晚都在\"似睡非睡\"。", score: 1 }
                        ]
                    },
                    {
                        id: "Q9",
                        type: "single",
                        category: "standard",
                        text: "清晨醒来时，您的第一感觉通常是？",
                        options: [
                            { text: "精力充沛：感觉神清气爽，身体和大脑都像\"充满电\"一样，已为新的一天做好准备。", score: 4 },
                             { text: "尚可接受：感觉基本睡够了，但仍有些许困意，需要一段时间（如喝杯咖啡）来完全清醒。", score: 3 },
                             { text: "明显疲惫：感觉身体沉重，像\"没睡够\"一样，需要挣扎着起床。", score: 2 },
                             { text: "醒来即耗竭：感觉比睡前更累，大脑昏沉，甚至伴有头痛或情绪低落。", score: 1 }
                        ]
                    },
                    {
                        id: "Q10",
                        type: "multiple",
                        category: "core",
                        text: "请您勾选出所有符合您近一个月睡眠情况的具体描述。(可多选)",
                        options: [
                            { text: "入睡困难，躺在床上大脑异常清醒，思绪万千", score: 1 },
                            { text: "睡眠很浅，容易被最轻微的声音或光线惊醒，多梦", score: 1 },
                            { text: "夜间频繁醒来（醒来2次及以上），或在凌晨（如3-4点）早醒后无法再入睡", score: 1 },
                            { text: "夜间有盗汗、身体燥热、腿部不宁（酸、麻、胀）或磨牙等身体不适", score: 1 },
                            { text: "睡醒后依旧感觉疲惫，脖子或后背僵硬疼痛，感觉\"睡了一场假觉\"", score: 1 },
                            { text: "即使睡够了时长，白天依然容易犯困，注意力难以集中", score: 1 },
                            { text: "我几乎没有以上任何问题", score: 0 }
                        ]
                    }
                ]
            },
            exercise: {
                title: "运动支柱",
                intro: "身体天生为活动而设计。规律的运动不仅塑造体型，更是提升精力、改善情绪、优化代谢的核心要素。让我们一同审视您的\"能量消耗\"模式。",
                questions: [
                    {
                        id: "Q11",
                        type: "single",
                        category: "standard",
                        text: "您平均每周进行几次能让自己\"心跳呼吸明显加快，但仍能说话\"的中等强度运动（如快走、慢跑、游泳、健身操等），每次至少持续30分钟？",
                        options: [
                            { text: "积极且规律：每周能保证4次及以上。", score: 4 },
                            { text: "有意识地参与：每周能进行2-3次。", score: 3 },
                            { text: "偶尔为之：每周仅能进行1次或更少。", score: 2 },
                            { text: "几乎从不：近一个月几乎没有进行过任何主动的体育锻炼。", score: 1 }
                        ]
                    },
                    {
                        id: "Q12",
                        type: "single",
                        category: "standard",
                        text: "除去刻意的运动时间，您的日常生活和工作状态更接近以下哪种\"活动模式\"？",
                        options: [
                            { text: "动态模式：我的工作或生活（如教师、销售、全职妈妈）要求我一天中大部分时间都需要站立或走动。", score: 4 },
                            { text: "混合模式：我的工作以静坐为主，但我有意识地、并频繁地起身活动、走动或走楼梯。", score: 3 },
                            { text: "静态模式：我一天中绝大部分时间都坐在办公桌前，经常一坐就是数小时，很少主动起身。", score: 2 },
                            { text: "深度静态模式：我不仅工作时长时间静坐，我的休闲时间也大多是坐着或躺着度过的（如看剧、玩游戏）。", score: 1 }
                        ]
                    },
                    {
                        id: "Q13",
                        type: "multiple",
                        category: "core",
                        text: "请选择所有阻碍您动起来，或在运动中遇到的真实困扰。(可多选)",
                        options: [
                            { text: "经常处于\"想动但又没力气动\"的状态，光是\"决定去运动\"这一步就耗尽了心力。", score: 1 },
                            { text: "工作、家务和照顾家人占据了所有时间，感觉完全没有属于自己的\"运动时间窗口\"。", score: 1 },
                            { text: "尝试过运动，但感觉效果甚微（如体重没变），因此很容易放弃。", score: 1 },
                            { text: "身体僵硬、平衡感差，或运动后身体（尤其是关节）的酸痛感会持续很久。", score: 1 },
                            { text: "在生理周期的某个阶段（如经前期或经期），会感到精力、体力明显下降，难以维持运动计划。", score: 1 },
                            { text: "觉得运动过程很枯燥，或者在公共场合（如健身房）运动会感到不自在、尴尬。", score: 1 },
                            { text: "我几乎没有以上任何困扰。", score: 0 }
                        ]
                    }
                ]
            },
            nutrition: {
                title: "营养支柱",
                intro: "\"人如其食\"。您吃的每一口食物，都在细胞层面塑造着您明天的健康。让我们一同来审视您的\"能量补给\"系统。",
                questions: [
                    {
                        id: "Q14",
                        type: "single",
                        category: "standard",
                        text: "您通常如何开启一天的饮食，即您的早餐习惯是怎样的？",
                        options: [
                            { text: "优质启动：早餐富含优质蛋白质（如鸡蛋、牛奶、豆浆）和健康脂肪，能提供持久的饱腹感和稳定的精力。", score: 4 },
                            { text: "常规启动：以复合碳水（如燕麦、全麦面包、杂粮粥）为主，能提供较为平稳的能量。", score: 3 },
                            { text: "高糖启动：早餐主要是精制碳水化合物（如白面包、包子、糕点）或含糖饮品，吃完很快又会饿。", score: 2 },
                            { text: "跳过/应付启动：几乎不吃早餐，或仅用一杯咖啡来开启一天。", score: 1 }
                        ]
                    },
                    {
                        id: "Q15",
                        type: "single",
                        category: "standard",
                        text: "纵观您的午餐和晚餐，哪种描述最贴近您的真实\"膳食模式\"？",
                        options: [
                            { text: "均衡自煮：大部分自己做饭，有意识地确保餐盘中至少一半是蔬菜，搭配足量的优质蛋白质和适量的好主食。", score: 4 },
                            { text: "外食优选：虽然经常在外就餐，但会主动选择更健康的选项，如轻食沙拉、均衡搭配的套餐或非油炸的菜品。", score: 3 },
                            { text: "便捷快餐：主要依赖外卖、快餐或食堂解决，饮食内容普遍高油、高盐、高碳水，蔬菜摄入严重不足。", score: 2 },
                            { text: "生存代替：经常因为忙碌而错过正餐，用零食、泡面、面包等高度加工食品来充饥。", score: 1 }
                        ]
                    },
                    {
                        id: "Q16",
                        type: "multiple",
                        category: "core",
                        text: "饮食不仅关乎吃什么，更关乎我们与食物的关系以及它如何影响我们的身心。请坦诚地选择，您在饮食方面正面临的所有困扰(可多选)",
                        options: [
                            { text: "不吃主食或甜食就心慌手抖，吃了又容易犯困、脑雾。", score: 1 },
                            { text: "习惯在压力、疲劳或无聊时，用高油盐、高糖分的食物来寻求慰藉和\"充电\"。", score: 1 },
                            { text: "感觉一天也离不开奶茶、咖啡或其它含糖饮料，否则情绪和精力都会变差。", score: 1 },
                            { text: "觉得自己吃得挺健康（如沙拉、全麦面包），但依然容易腹胀、疲劳或体重难以下降。", score: 1 },
                            { text: "经常处于\"严格控制饮食\"和\"失控暴饮暴食\"的两种状态间摇摆，并伴随强烈的负罪感。", score: 1 },
                            { text: "自己的饮食常常要将就家人（尤其是孩子）的口味和时间，导致营养摄入不均衡或不规律。", score: 1 },
                            { text: "我几乎没有以上任何困扰。", score: 0 }
                        ]
                    }
                ]
            },
            gut: {
                title: "肠道健康支柱",
                intro: "肠道是健康的\"根基\"，超过70%的免疫细胞定居于此。肠道的信号至关重要。",
                questions: [
                    {
                        id: "Q17",
                        type: "single",
                        category: "standard",
                        text: "在吃完一顿正餐后，您的上腹部（胃部）通常是什么感觉？",
                        options: [
                            { text: "轻松舒适：感觉食物被顺利消化，身体轻盈有活力。", score: 4 },
                            { text: "感觉正常：有饱腹感，但没有明显不适。", score: 3 },
                            { text: "腹胀沉重：经常感觉腹部胀满，像有石头堵着，食物很久才消化掉。", score: 2 },
                            { text: "不适明显：经常感到烧心、胃酸反流或缓缓作痛。", score: 1 }
                        ]
                    },
                    {
                        id: "Q18",
                        type: "single",
                        category: "standard",
                        text: "您近一个月的排便规律和形态，整体来看最符合哪种描述？",
                        options: [
                            { text: "非常理想：几乎每日都有1-2次规律、顺畅的排便，粪便成形如香蕉状。", score: 4 },
                            { text: "基本正常：大致能保证每日排便，但偶尔粪便形态不佳（偏硬或偏软）。", score: 3 },
                            { text: "经常紊乱：排便时间和状态非常不规律，经常在便秘（干硬、数日一次）和腹泻（稀烂、一日多次）之间摇摆。", score: 2 },
                            { text: "长期失衡：存在长期、顽固的便秘或腹泻问题，常有排不尽感。", score: 1 }
                        ]
                    },
                    {
                        id: "Q19",
                        type: "single",
                        category: "standard",
                        text: "当您感到压力大或情绪紧张时，您的肠道通常会作何反应？",
                        options: [
                            { text: "几乎无反应：肠道功能稳定，基本不受情绪波动的影响。", score: 4 },
                            { text: "轻微关联：在极大的压力下，会感觉肠胃有些许不适。", score: 3 },
                            { text: "明显关联：情绪一紧张，肠道就容易出现痉挛、腹痛或排便习惯改变。", score: 2 },
                            { text: "高度同步：肠道几乎成了情绪的\"晴雨表\"，任何情绪波动都会立刻在肠道上有所体现。", score: 1 }
                        ]
                    },
                    {
                        id: "Q20",
                        type: "single",
                        category: "standard",
                        text: "您是否注意到，当肠胃不适时，您的身体其他部位（尤其是皮肤）也会随之出现问题？",
                        options: [
                            { text: "基本无关联：肠道问题似乎只影响消化系统本身。", score: 4 },
                            { text: "偶有关联：偶尔怀疑肠胃不好时，脸上更容易长痘。", score: 3 },
                            { text: "比较确定有关联：肠胃不适期间，皮肤（面部、后背）出问题或过敏的概率明显增加。", score: 2 },
                            { text: "有非常清晰的关联：皮肤状态几乎就是肠道健康的镜子，甚至有时会伴随关节疼痛或疲劳感加重。", score: 1 }
                        ]
                    },
                    {
                        id: "Q21",
                        type: "multiple",
                        category: "core",
                        text: "请仔细阅读并选择您在肠道和消化方面遇到的所有具体症状。这能帮助我们了解您肠道生态的真实状况 (可多选)",
                        options: [
                            { text: "餐后容易腹胀、打嗝、胃气多，感觉食物长时间堵在胃里", score: 1 },
                            { text: "排便困难、费力，或数日一次（便秘）", score: 1 },
                            { text: "大便不成形，质地稀烂、粘马桶，或一天多次（腹泻）", score: 1 },
                            { text: "有烧心、胃酸反流的感觉", score: 1 },
                            { text: "皮肤容易出现原因不明的湿疹、瘙痒或痤疮", score: 1 },
                            { text: "食用某些特定食物（如火锅、烧烤、油腻、海鲜食物）后，肠胃明显不适", score: 1 },
                            { text: "我几乎没有以上任何症状", score: 0 }
                        ]
                    }
                ]
            },
            stress: {
                title: "压力与情绪支柱",
                intro: "情绪是内心的指南针，压力是生活的背景音。清晰地认知它们，是掌握身心健康主动权的第一步。",
                questions: [
                    {
                        id: "Q22",
                        type: "single",
                        category: "standard",
                        text: "在过去一个月，您感到紧张、担忧，仿佛\"杞人忧天\"的频率有多高？",
                        options: [
                            { text: "几乎没有：内心常态是平静、踏实的。", score: 4 },
                            { text: "有过几天：通常与特定的、可预见的事件相关联。", score: 3 },
                            { text: "超过一半的时间：担忧似乎成了一种背景音，挥之不去。", score: 2 },
                            { text: "几乎每天：总是感到紧张，且难以自我控制这种担忧。", score: 1 }
                        ]
                    },
                    {
                        id: "Q23",
                        type: "single",
                        category: "standard",
                        text: "即使在休息时间（如周末或假期），您是否感觉自己也很难真正地\"松弛\"下来？",
                        options: [
                            { text: "完全不会：能够轻松地\"一键切换\"到放松、享受的模式。", score: 4 },
                            { text: "偶尔会：需要一些时间或仪式（如喝杯酒、看会剧）才能慢慢放松下来。", score: 3 },
                            { text: "经常如此：身体虽然在休息，但大脑依然高速运转，思绪万千。", score: 2 },
                            { text: "几乎总是：感觉身体和精神总是处于一种\"紧绷\"或\"警觉\"的状态，无法放松。", score: 1 }
                        ]
                    },
                    {
                        id: "Q24",
                        type: "single",
                        category: "standard",
                        text: "当面临压力或情绪低落时，您的第一倾向（最常用的方法）是什么？",
                        options: [
                            { text: "积极疏导：会主动通过运动、冥想、书写或与人倾诉来处理情绪。", score: 4 },
                            { text: "转移回避：倾向于投身到工作、家务或爱好中，以暂时忘记烦恼。", score: 3 },
                            { text: "被动\"麻痹\"：习惯性地通过长时间刷手机、看剧等方式进行被动娱乐，以逃避现实感受。", score: 2 },
                            { text: "物质慰藉：倾向于通过进食（尤其是甜食或垃圾食品）、饮酒或购物来寻求即时满足。", score: 1 }
                        ]
                    },
                    {
                        id: "Q25",
                        type: "single",
                        category: "standard",
                        text: "您如何评价自己近一个月的专注力和思维清晰度？",
                        options: [
                            { text: "非常清晰：思路敏捷，能长时间保持专注，轻松处理复杂任务。", score: 4 },
                            { text: "基本正常：大部分时间还好，但在疲劳或压力大时，会感到注意力分散。", score: 3 },
                            { text: "经常\"脑雾\"：常常感觉思维迟钝、混乱，像隔着一层雾，需要很大努力才能集中精神。", score: 2 },
                            { text: "严重受损：专注力和记忆力明显下降，已经开始影响到工作效率或日常生活。", score: 1 }
                        ]
                    },
                    {
                        id: "Q26",
                        type: "multiple",
                        category: "core",
                        text: "请勾选出所有符合您当前状态的具体表现。(可多选)",
                        options: [
                            { text: "神经总是紧绷，容易被小事激惹，对亲近的人没耐心，事后又感到内疚。", score: 1 },
                            { text: "感觉身体和情绪的被耗尽，对什么都提不起兴趣，只想一个人待着。", score: 1 },
                            { text: "注意力难以集中，记忆力明显下降。", score: 1 },
                            { text: "肩颈、后背或下颌（咬肌）长期僵硬紧张，或有不明原因的头痛、心慌。", score: 1 },
                            { text: "对自己要求很高，害怕犯错，做事前反复思虑，做事后又不停回想，感觉很累。", score: 1 },
                            { text: "很容易因为他人的评价或事情的不顺利而感到沮丧，怀疑自己的能力和价值。", score: 1 },
                            { text: "我几乎没有以上任何状态。", score: 0 }
                        ]
                     }
                ]
            },
            comprehensive: {
                title: "综合感受",
                intro: "",
                questions: [
                    {
                        id: "Q27",
                        type: "single",
                        category: "standard",
                        text: "总体来说，您如何评价自己近一个月的精力水平？",
                        options: [
                            { text: "精力充沛，日常活动无明显疲劳", score: 4 },
                            { text: "精力一般，偶尔感到疲劳", score: 3 },
                            { text: "精力较差，经常觉得疲惫", score: 2 },
                            { text: "极度疲惫，没有精力", score: 1 }
                        ]
                    },
                    {
                        id: "Q28",
                        type: "single",
                        category: "standard",
                        text: "您感觉自己的疲劳感，更多是\"身体上的累\"（如四肢沉重、不想动），还是\"精神上的累\"（如脑子转不动、情绪低落）？",
                        options: [
                            { text: "身体上的累为主", score: 3 },
                            { text: "精神上的累为主", score: 2 },
                            { text: "两者差不多", score: 1 },
                            { text: "没什么疲劳感", score: 4 }
                        ]
                    },
                    {
                        id: "Q29",
                        type: "single",
                        category: "standard",
                        text: "您是否感觉，自己的精力、情绪和睡眠状况会受到生理周期的显著影响？(仅女性用户回答)",
                        options: [
                            { text: "是的，影响非常大", score: 1 },
                            { text: "有一些影响", score: 2 },
                            { text: "不太确定", score: 3 },
                            { text: "基本没影响", score: 4 }
                        ]
                    }
                ]
            }
        };

        // 全局变量
        let currentSection = 'sleep';
        let currentQuestionIndex = 0;
        let answers = {};
        let allQuestions = [];
        let currentQuestionGlobalIndex = 0;
        
        // 省市数据
         const provinceData = {
             "北京市": ["东城区", "西城区", "朝阳区", "丰台区", "石景山区", "海淀区", "门头沟区", "房山区", "通州区", "顺义区", "昌平区", "大兴区", "怀柔区", "平谷区", "密云区", "延庆区"],
             "上海市": ["黄浦区", "徐汇区", "长宁区", "静安区", "普陀区", "虹口区", "杨浦区", "闵行区", "宝山区", "嘉定区", "浦东新区", "金山区", "松江区", "青浦区", "奉贤区", "崇明区"],
             "广东省": ["广州市", "深圳市", "珠海市", "汕头市", "佛山市", "韶关市", "湛江市", "肇庆市", "江门市", "茂名市", "惠州市", "梅州市", "汕尾市", "河源市", "阳江市", "清远市", "东莞市", "中山市", "潮州市", "揭阳市", "云浮市"],
             "江苏省": ["南京市", "无锡市", "徐州市", "常州市", "苏州市", "南通市", "连云港市", "淮安市", "盐城市", "扬州市", "镇江市", "泰州市", "宿迁市"],
             "浙江省": ["杭州市", "宁波市", "温州市", "嘉兴市", "湖州市", "绍兴市", "金华市", "衢州市", "舟山市", "台州市", "丽水市"],
             "山东省": ["济南市", "青岛市", "淄博市", "枣庄市", "东营市", "烟台市", "潍坊市", "济宁市", "泰安市", "威海市", "日照市", "临沂市", "德州市", "聊城市", "滨州市", "菏泽市"],
             "河南省": ["郑州市", "开封市", "洛阳市", "平顶山市", "安阳市", "鹤壁市", "新乡市", "焦作市", "濮阳市", "许昌市", "漯河市", "三门峡市", "南阳市", "商丘市", "信阳市", "周口市", "驻马店市"],
             "湖北省": ["武汉市", "黄石市", "十堰市", "宜昌市", "襄阳市", "鄂州市", "荆门市", "孝感市", "荆州市", "黄冈市", "咸宁市", "随州市", "恩施州"],
             "湖南省": ["长沙市", "株洲市", "湘潭市", "衡阳市", "邵阳市", "岳阳市", "常德市", "张家界市", "益阳市", "郴州市", "永州市", "怀化市", "娄底市", "湘西州"],
             "四川省": ["成都市", "自贡市", "攀枝花市", "泸州市", "德阳市", "绵阳市", "广元市", "遂宁市", "内江市", "乐山市", "南充市", "眉山市", "宜宾市", "广安市", "达州市", "雅安市", "巴中市", "资阳市"],
             "河北省": ["石家庄市", "唐山市", "秦皇岛市", "邯郸市", "邢台市", "保定市", "张家口市", "承德市", "沧州市", "廊坊市", "衡水市"],
             "山西省": ["太原市", "大同市", "阳泉市", "长治市", "晋城市", "朔州市", "晋中市", "运城市", "忻州市", "临汾市", "吕梁市"],
             "安徽省": ["合肥市", "芜湖市", "蚌埠市", "淮南市", "马鞍山市", "淮北市", "铜陵市", "安庆市", "黄山市", "滁州市", "阜阳市", "宿州市", "六安市", "亳州市", "池州市", "宣城市"],
             "福建省": ["福州市", "厦门市", "莆田市", "三明市", "泉州市", "漳州市", "南平市", "龙岩市", "宁德市"],
             "江西省": ["南昌市", "景德镇市", "萍乡市", "九江市", "新余市", "鹰潭市", "赣州市", "吉安市", "宜春市", "抚州市", "上饶市"],
             "辽宁省": ["沈阳市", "大连市", "鞍山市", "抚顺市", "本溪市", "丹东市", "锦州市", "营口市", "阜新市", "辽阳市", "盘锦市", "铁岭市", "朝阳市", "葫芦岛市"],
             "吉林省": ["长春市", "吉林市", "四平市", "辽源市", "通化市", "白山市", "松原市", "白城市", "延边州"],
             "黑龙江省": ["哈尔滨市", "齐齐哈尔市", "鸡西市", "鹤岗市", "双鸭山市", "大庆市", "伊春市", "佳木斯市", "七台河市", "牡丹江市", "黑河市", "绥化市", "大兴安岭地区"],
             "陕西省": ["西安市", "铜川市", "宝鸡市", "咸阳市", "渭南市", "延安市", "汉中市", "榆林市", "安康市", "商洛市"],
             "甘肃省": ["兰州市", "嘉峪关市", "金昌市", "白银市", "天水市", "武威市", "张掖市", "平凉市", "酒泉市", "庆阳市", "定西市", "陇南市", "临夏州", "甘南州"],
             "青海省": ["西宁市", "海东市", "海北州", "黄南州", "海南州", "果洛州", "玉树州", "海西州"],
             "宁夏回族自治区": ["银川市", "石嘴山市", "吴忠市", "固原市", "中卫市"],
             "新疆维吾尔自治区": ["乌鲁木齐市", "克拉玛依市", "吐鲁番市", "哈密市", "昌吉州", "博尔塔拉州", "巴音郭楞州", "阿克苏地区", "克孜勒苏州", "喀什地区", "和田地区", "伊犁州", "塔城地区", "阿勒泰地区"],
             "西藏自治区": ["拉萨市", "日喀则市", "昌都市", "林芝市", "山南市", "那曲市", "阿里地区"],
             "内蒙古自治区": ["呼和浩特市", "包头市", "乌海市", "赤峰市", "通辽市", "鄂尔多斯市", "呼伦贝尔市", "巴彦淖尔市", "乌兰察布市", "兴安盟", "锡林郭勒盟", "阿拉善盟"],
             "广西壮族自治区": ["南宁市", "柳州市", "桂林市", "梧州市", "北海市", "防城港市", "钦州市", "贵港市", "玉林市", "百色市", "贺州市", "河池市", "来宾市", "崇左市"],
             "云南省": ["昆明市", "曲靖市", "玉溪市", "保山市", "昭通市", "丽江市", "普洱市", "临沧市", "楚雄州", "红河州", "文山州", "西双版纳州", "大理州", "德宏州", "怒江州", "迪庆州"],
             "贵州省": ["贵阳市", "六盘水市", "遵义市", "安顺市", "毕节市", "铜仁市", "黔西南州", "黔东南州", "黔南州"],
             "海南省": ["海口市", "三亚市", "三沙市", "儋州市", "五指山市", "琼海市", "文昌市", "万宁市", "东方市", "定安县", "屯昌县", "澄迈县", "临高县", "白沙县", "昌江县", "乐东县", "陵水县", "保亭县", "琼中县"],
             "台湾省": ["台北市", "新北市", "桃园市", "台中市", "台南市", "高雄市", "基隆市", "新竹市", "嘉义市", "新竹县", "苗栗县", "彰化县", "南投县", "云林县", "嘉义县", "屏东县", "宜兰县", "花莲县", "台东县", "澎湖县", "金门县", "连江县"],
             "香港特别行政区": ["中西区", "湾仔区", "东区", "南区", "油尖旺区", "深水埗区", "九龙城区", "黄大仙区", "观塘区", "荃湾区", "屯门区", "元朗区", "北区", "大埔区", "沙田区", "西贡区", "葵青区", "离岛区"],
             "澳门特别行政区": ["澳门半岛", "氹仔", "路环"]
         };

        // 初始化省份选项
         function initProvinces() {
             const provinceSelect = document.getElementById('province');
             Object.keys(provinceData).forEach(province => {
                 const option = document.createElement('option');
                 option.value = province;
                 option.textContent = province;
                 provinceSelect.appendChild(option);
             });
         }

         // 更新城市选项
         function updateCities() {
             const provinceSelect = document.getElementById('province');
             const citySelect = document.getElementById('city');
             const selectedProvince = provinceSelect.value;
             
             // 清空城市选项
             citySelect.innerHTML = '<option value="">请选择城市</option>';
             
             if (selectedProvince && provinceData[selectedProvince]) {
                 provinceData[selectedProvince].forEach(city => {
                     const option = document.createElement('option');
                     option.value = city;
                     option.textContent = city;
                     citySelect.appendChild(option);
                 });
             }
         }

         // 初始化出生年份选项
         function initBirthYears() {
             const birthYearSelect = document.getElementById('birth-year');
             for (let year = 2005; year >= 1965; year--) {
                 const option = document.createElement('option');
                 option.value = year;
                 option.textContent = year + '年';
                 if (year === 1985) {
                     option.selected = true;
                 }
                 birthYearSelect.appendChild(option);
             }
         }

         // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化出生年份选项
            initBirthYears();
            // 初始化省份选项
            initProvinces();
            
            // 扁平化所有问题
            Object.keys(questionnaire).forEach(sectionKey => {
                questionnaire[sectionKey].questions.forEach(question => {
                    question.section = sectionKey;
                    allQuestions.push(question);
                });
            });
            
            updateProgress();
        });

        // 开始测试（从介绍页面到基本信息页面）
        function startTest() {
            document.getElementById('introPage').classList.add('hidden');
            document.getElementById('basicInfoPage').classList.remove('hidden');
            updateProgress();
        }

        // 更新进度条
        function updateProgress() {
            const totalSteps = allQuestions.length + 3; // 包括介绍页面、基本信息和结果页面
            let currentStep = 0;
            
            if (!document.getElementById('introPage').classList.contains('hidden')) {
                currentStep = 1;
            } else if (!document.getElementById('basicInfoPage').classList.contains('hidden')) {
                currentStep = 2;
            } else if (!document.getElementById('resultsPage').classList.contains('hidden')) {
                currentStep = totalSteps;
            } else {
                currentStep = currentQuestionGlobalIndex + 3;
            }
            
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // 下一页（从基本信息到问卷）
        function nextPage() {
            // 验证基本信息
            const birthYear = document.getElementById('birth-year').value;
            const gender = document.getElementById('gender').value;
            const province = document.getElementById('province').value;
            const city = document.getElementById('city').value;
            const occupation = document.getElementById('occupation').value;
            const maritalStatus = document.getElementById('marital-status').value;
            
            if (!birthYear || !gender || !province || !city || !occupation || !maritalStatus) {
                alert('请填写完整的基本信息');
                return;
            }
            
            // 计算年龄
            const currentYear = new Date().getFullYear();
            const age = currentYear - parseInt(birthYear);
            
            // 保存基本信息
            answers.basicInfo = { birthYear, age, gender, province, city, occupation, maritalStatus };
            
            // 切换到问卷页面
            document.getElementById('basicInfoPage').classList.add('hidden');
            document.getElementById('questionnairePage').classList.remove('hidden');
            
            // 显示第一个问题
            showQuestion();
            updateProgress();
        }

        // 显示当前问题
        function showQuestion() {
            const question = allQuestions[currentQuestionGlobalIndex];
            const container = document.getElementById('questionContainer');
            
            // 更新章节标题
            document.getElementById('currentSectionTitle').textContent = questionnaire[question.section].title;
            
            // 构建问题HTML
            let html = `
                <div class="question">
                    <div class="question-title">${question.text}</div>
                    <div class="question-type">${question.type === 'single' ? '单选题' : '多选题'}</div>
                    <div class="options">
            `;
            
            question.options.forEach((option, index) => {
                const inputType = question.type === 'single' ? 'radio' : 'checkbox';
                const inputName = question.type === 'single' ? question.id : `${question.id}_${index}`;
                const isChecked = answers[question.id] && 
                    (question.type === 'single' ? 
                        answers[question.id] === index : 
                        answers[question.id].includes(index));
                
                html += `
                    <div class="option ${isChecked ? 'selected' : ''}" onclick="selectOption('${question.id}', ${index}, '${question.type}')">
                        <input type="${inputType}" name="${inputName}" value="${index}" ${isChecked ? 'checked' : ''}>
                        <span>${option.text}</span>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // 如果是多选题，更新UI状态（包括禁用状态）
            if (question.type === 'multiple') {
                updateMultipleChoiceUI(question.id, question);
            }
            
            // 更新导航按钮
            document.getElementById('prevBtn').style.display = currentQuestionGlobalIndex > 0 ? 'block' : 'none';
            document.getElementById('nextBtn').textContent = 
                currentQuestionGlobalIndex === allQuestions.length - 1 ? '查看结果' : '下一题';
        }

        // 选择选项
        function selectOption(questionId, optionIndex, type) {
            if (type === 'single') {
                answers[questionId] = optionIndex;
                // 更新UI
                document.querySelectorAll(`input[name="${questionId}"]`).forEach((input, index) => {
                    const option = input.closest('.option');
                    if (index === optionIndex) {
                        input.checked = true;
                        option.classList.add('selected');
                    } else {
                        input.checked = false;
                        option.classList.remove('selected');
                    }
                });
            } else {
                if (!answers[questionId]) {
                    answers[questionId] = [];
                }
                
                const currentQuestion = allQuestions.find(q => q.id === questionId);
                const lastOptionIndex = currentQuestion.options.length - 1;
                const isLastOption = optionIndex === lastOptionIndex;
                const lastOptionText = currentQuestion.options[lastOptionIndex].text;
                const isNoneOption = lastOptionText.includes('我几乎没有以上任何');
                
                // 检查点击的选项是否被禁用
                const clickedOptionElement = document.querySelector(`input[name="${questionId}_${optionIndex}"]`).closest('.option');
                if (clickedOptionElement.classList.contains('disabled')) {
                    return; // 如果选项被禁用，直接返回，不执行任何操作
                }
                
                // 如果是"我几乎没有以上任何"选项
                if (isLastOption && isNoneOption) {
                    if (answers[questionId].includes(optionIndex)) {
                        // 取消选择"我几乎没有以上任何"选项
                        answers[questionId] = answers[questionId].filter(idx => idx !== optionIndex);
                    } else {
                        // 选择"我几乎没有以上任何"选项，清除其他所有选项
                        answers[questionId] = [optionIndex];
                    }
                } else {
                    // 选择其他选项时，如果"我几乎没有以上任何"已被选中，则先清除它
                    if (!isNoneOption && answers[questionId].includes(lastOptionIndex)) {
                        answers[questionId] = answers[questionId].filter(idx => idx !== lastOptionIndex);
                    }
                    
                    const index = answers[questionId].indexOf(optionIndex);
                    if (index > -1) {
                        answers[questionId].splice(index, 1);
                    } else {
                        answers[questionId].push(optionIndex);
                    }
                }
                
                // 更新所有选项的UI状态和禁用状态
                updateMultipleChoiceUI(questionId, currentQuestion);
            }
        }
        
        // 更新多选题的UI状态
        function updateMultipleChoiceUI(questionId, currentQuestion) {
            const lastOptionIndex = currentQuestion.options.length - 1;
            const lastOptionText = currentQuestion.options[lastOptionIndex].text;
            const isNoneOption = lastOptionText.includes('我几乎没有以上任何');
            
            // 检查是否有其他选项被选中（除了"我几乎没有以上任何"选项）
            const hasOtherOptionsSelected = answers[questionId] && answers[questionId].some(idx => idx !== lastOptionIndex);
            
            currentQuestion.options.forEach((option, idx) => {
                const input = document.querySelector(`input[name="${questionId}_${idx}"]`);
                const optionElement = input.closest('.option');
                
                // 更新选中状态
                if (answers[questionId] && answers[questionId].includes(idx)) {
                    input.checked = true;
                    optionElement.classList.add('selected');
                } else {
                    input.checked = false;
                    optionElement.classList.remove('selected');
                }
                
                // 更新禁用状态
                if (isNoneOption && idx === lastOptionIndex && hasOtherOptionsSelected) {
                    // 如果有其他选项被选中，禁用"我几乎没有以上任何"选项
                    optionElement.classList.add('disabled');
                    input.disabled = true;
                } else {
                    // 其他情况下移除禁用状态
                    optionElement.classList.remove('disabled');
                    input.disabled = false;
                }
            });
        }

        // 下一题
        function nextQuestion() {
            const currentQuestion = allQuestions[currentQuestionGlobalIndex];
            
            // 验证是否已回答
            if (answers[currentQuestion.id] === undefined || answers[currentQuestion.id] === null || 
                (Array.isArray(answers[currentQuestion.id]) && answers[currentQuestion.id].length === 0)) {
                alert('请回答当前问题后再继续');
                return;
            }
            
            if (currentQuestionGlobalIndex < allQuestions.length - 1) {
                currentQuestionGlobalIndex++;
                showQuestion();
                updateProgress();
            } else {
                // 显示结果
                showResults();
            }
        }

        // 上一题
        function prevQuestion() {
            if (currentQuestionGlobalIndex > 0) {
                currentQuestionGlobalIndex--;
                showQuestion();
                updateProgress();
            }
        }

        // 计算结果
        function calculateResults() {
            const pillarScores = {
                sleep: 0,
                exercise: 0,
                nutrition: 0,
                gut: 0,
                stress: 0
            };
            
            const pillarMaxScores = {
                sleep: 25,  // Q6(4) + Q7(4) + Q8(4) + Q9(4) + Q10(9) = 25分
                exercise: 17, // Q11(4) + Q12(4) + Q13(9) = 17分
                nutrition: 17, // Q14(4) + Q15(4) + Q16(9) = 17分
                gut: 25,    // Q17(4) + Q18(4) + Q19(4) + Q20(4) + Q21(9) = 25分
                stress: 25  // Q22(4) + Q23(4) + Q24(4) + Q25(4) + Q26(9) = 25分
            };
            
            // 计算各支柱得分（跳过comprehensive支柱）
            allQuestions.forEach(question => {
                // 跳过综合感受部分，不计分
                if (question.section === 'comprehensive') {
                    return;
                }
                
                const answer = answers[question.id];
                let score = 0;
                
                if (question.type === 'single') {
                    if (answer !== undefined) {
                        score = question.options[answer].score;
                    }
                } else {
                    // 多选题处理
                    if (answer && Array.isArray(answer)) {
                        if (question.category === 'core') {
                            // 核心诊断题：症状负荷反向计分法
                            // 检查是否选择了"我几乎没有以上任何问题/症状"
                            const noSymptomsIndex = question.options.findIndex(opt => 
                                opt.text.includes('我几乎没有以上任何') || opt.score === 0
                            );
                            
                            if (answer.includes(noSymptomsIndex)) {
                                // 选择了"无症状"选项，得满分
                                score = 9;
                            } else {
                                // 根据选择的症状数量反向计分
                                const symptomCount = answer.length;
                                if (symptomCount === 1) score = 7.5;
                                else if (symptomCount === 2) score = 6;
                                else if (symptomCount === 3) score = 4.5;
                                else if (symptomCount === 4) score = 3;
                                else if (symptomCount === 5) score = 1.5;
                                else if (symptomCount >= 6) score = 0;
                                else score = 9; // 未选择任何选项
                            }
                        } else {
                            // 普通多选题：累加分数
                            answer.forEach(optionIndex => {
                                score += question.options[optionIndex].score;
                            });
                        }
                    }
                }
                
                pillarScores[question.section] += score;
            });
            
            // 计算百分比
            const pillarPercentages = {};
            Object.keys(pillarScores).forEach(pillar => {
                pillarPercentages[pillar] = Math.round((pillarScores[pillar] / pillarMaxScores[pillar]) * 100);
            });
            
            // 计算总体健康度
            const totalScore = Object.values(pillarScores).reduce((sum, score) => sum + score, 0);
            const totalMaxScore = Object.values(pillarMaxScores).reduce((sum, score) => sum + score, 0);
            const overallHealthPercentage = Math.round((totalScore / totalMaxScore) * 100);
            
            // 确定健康等级
            let healthLevel = '';
            if (overallHealthPercentage >= 90) {
                healthLevel = '状态极佳';
            } else if (overallHealthPercentage >= 75) {
                healthLevel = '状态良好';
            } else if (overallHealthPercentage >= 60) {
                healthLevel = '待改善';
            } else if (overallHealthPercentage >= 40) {
                healthLevel = '警报状态';
            } else {
                healthLevel = '急需干预';
            }
            
            // 生成个性化建议
            const recommendations = generateRecommendations(pillarPercentages, answers);
            
            return {
                pillarScores,
                pillarPercentages,
                overallHealthPercentage,
                healthLevel,
                recommendations,
                timestamp: new Date().toLocaleString('zh-CN'),
                basicInfo: answers.basicInfo,
                maxScores: pillarMaxScores
            };
        }

        // 生成个性化建议
        function generateRecommendations(percentages, userAnswers) {
            const recommendations = [];
            
            // 找出得分最低的支柱
            const sortedPillars = Object.entries(percentages).sort((a, b) => a[1] - b[1]);
            
            const pillarNames = {
                sleep: '睡眠',
                exercise: '运动',
                nutrition: '营养',
                gut: '肠道健康',
                stress: '压力管理'
            };
            
            // 为每个支柱提供详细的得分解读和建议
            Object.entries(percentages).forEach(([pillar, score]) => {
                const detailedAdvice = getDetailedPillarAdvice(pillar, score, userAnswers);
                recommendations.push({
                    title: `${pillarNames[pillar]}支柱 (${score}%)`,
                    content: detailedAdvice
                });
            });
            
            // 添加综合建议
            const overallAdvice = getOverallAdvice(percentages, sortedPillars);
            recommendations.push({
                title: '综合改善建议',
                content: overallAdvice
            });
            
            return recommendations;
        }

        // 获取详细的支柱建议
        function getDetailedPillarAdvice(pillar, score, userAnswers) {
            let advice = '';
            
            // 得分解读
            if (score >= 90) {
                advice += `<strong>🌟 优秀水平</strong><br>您在${pillar === 'sleep' ? '睡眠' : pillar === 'exercise' ? '运动' : pillar === 'nutrition' ? '营养' : pillar === 'gut' ? '肠道健康' : '压力管理'}方面表现优秀！`;
            } else if (score >= 75) {
                advice += `<strong>✅ 良好水平</strong><br>您在${pillar === 'sleep' ? '睡眠' : pillar === 'exercise' ? '运动' : pillar === 'nutrition' ? '营养' : pillar === 'gut' ? '肠道健康' : '压力管理'}方面表现良好，有进一步提升的空间。`;
            } else if (score >= 60) {
                advice += `<strong>⚠️ 需要改善</strong><br>您在${pillar === 'sleep' ? '睡眠' : pillar === 'exercise' ? '运动' : pillar === 'nutrition' ? '营养' : pillar === 'gut' ? '肠道健康' : '压力管理'}方面需要重点关注和改善。`;
            } else if (score >= 40) {
                advice += `<strong>🚨 警报状态</strong><br>您在${pillar === 'sleep' ? '睡眠' : pillar === 'exercise' ? '运动' : pillar === 'nutrition' ? '营养' : pillar === 'gut' ? '肠道健康' : '压力管理'}方面存在明显问题，需要立即采取行动。`;
            } else {
                advice += `<strong>🆘 急需干预</strong><br>您在${pillar === 'sleep' ? '睡眠' : pillar === 'exercise' ? '运动' : pillar === 'nutrition' ? '营养' : pillar === 'gut' ? '肠道健康' : '压力管理'}方面急需专业指导和系统性改善。`;
            }
            
            advice += '<br><br>';
            
            // 根据具体支柱提供详细建议
            switch(pillar) {
                case 'sleep':
                    advice += getSleepAdvice(score, userAnswers);
                    break;
                case 'exercise':
                    advice += getExerciseAdvice(score, userAnswers);
                    break;
                case 'nutrition':
                    advice += getNutritionAdvice(score, userAnswers);
                    break;
                case 'gut':
                    advice += getGutAdvice(score, userAnswers);
                    break;
                case 'stress':
                    advice += getStressAdvice(score, userAnswers);
                    break;
            }
            
            return advice;
        }
        
        // 睡眠建议
        function getSleepAdvice(score, userAnswers) {
            let advice = '<strong>具体建议：</strong><br>';
            if (score >= 75) {
                advice += '• 继续保持规律的作息时间<br>• 优化睡眠环境（温度、光线、噪音）<br>• 建立放松的睡前仪式';
            } else {
                advice += '• 建立固定的睡觉和起床时间<br>• 睡前1小时避免电子设备<br>• 创造舒适的睡眠环境<br>• 避免睡前大量进食和饮酒<br>• 考虑放松技巧如冥想或深呼吸';
            }
            return advice;
        }
        
        // 运动建议
        function getExerciseAdvice(score, userAnswers) {
            let advice = '<strong>具体建议：</strong><br>';
            if (score >= 75) {
                advice += '• 继续保持现有运动习惯<br>• 尝试增加运动的多样性<br>• 适当增加力量训练';
            } else {
                advice += '• 从每周2-3次30分钟中等强度运动开始<br>• 选择喜欢的运动形式（如快走、游泳、跳舞）<br>• 增加日常活动量（爬楼梯、步行上班）<br>• 设定可实现的小目标<br>• 寻找运动伙伴增加动力';
            }
            return advice;
        }
        
        // 营养建议
        function getNutritionAdvice(score, userAnswers) {
            let advice = '<strong>具体建议：</strong><br>';
            if (score >= 75) {
                advice += '• 继续保持均衡饮食<br>• 注意食物多样性<br>• 适量补充优质脂肪';
            } else {
                advice += '• 确保每餐包含蛋白质、蔬菜和复合碳水<br>• 减少加工食品和含糖饮料<br>• 增加蔬菜水果摄入量<br>• 规律用餐时间<br>• 充足饮水（每天1.5-2升）';
            }
            return advice;
        }
        
        // 肠道健康建议
        function getGutAdvice(score, userAnswers) {
            let advice = '<strong>具体建议：</strong><br>';
            if (score >= 75) {
                advice += '• 继续摄入发酵食品<br>• 保持膳食纤维摄入<br>• 注意食物不耐受';
            } else {
                advice += '• 增加发酵食品（酸奶、泡菜、纳豆）<br>• 多吃富含膳食纤维的食物<br>• 减少高度加工食品<br>• 注意食物过敏原<br>• 管理压力以改善肠道功能';
            }
            return advice;
        }
        
        // 压力管理建议
        function getStressAdvice(score, userAnswers) {
            let advice = '<strong>具体建议：</strong><br>';
            if (score >= 75) {
                advice += '• 继续保持良好的压力管理习惯<br>• 定期进行放松活动<br>• 保持工作生活平衡';
            } else {
                advice += '• 学习压力管理技巧（深呼吸、冥想）<br>• 建立规律的放松时间<br>• 适当运动释放压力<br>• 寻求社会支持<br>• 必要时考虑专业心理咨询';
            }
            return advice;
        }
        
        // 综合建议
        function getOverallAdvice(percentages, sortedPillars) {
            const lowestPillar = sortedPillars[0];
            const highestPillar = sortedPillars[sortedPillars.length - 1];
            
            let advice = `<strong>优先改善重点：</strong>${lowestPillar[0] === 'sleep' ? '睡眠' : lowestPillar[0] === 'exercise' ? '运动' : lowestPillar[0] === 'nutrition' ? '营养' : lowestPillar[0] === 'gut' ? '肠道健康' : '压力管理'}支柱（${lowestPillar[1]}%）<br><br>`;
            
            advice += `<strong>保持优势：</strong>${highestPillar[0] === 'sleep' ? '睡眠' : highestPillar[0] === 'exercise' ? '运动' : highestPillar[0] === 'nutrition' ? '营养' : highestPillar[0] === 'gut' ? '肠道健康' : '压力管理'}支柱表现最佳（${highestPillar[1]}%）<br><br>`;
            
            advice += '<strong>整体建议：</strong><br>';
            advice += '• 健康是一个整体系统，各支柱相互影响<br>';
            advice += '• 建议从得分最低的支柱开始改善<br>';
            advice += '• 设定小目标，循序渐进<br>';
            advice += '• 定期重新评估，跟踪进展<br>';
            advice += '• 必要时寻求专业指导';
            
            return advice;
        }

        // 创建雷达图
        function createRadarChart(pillarPercentages) {
            const ctx = document.getElementById('healthRadarChart').getContext('2d');
            
            // 销毁之前的图表实例（如果存在）
            if (window.healthChart) {
                window.healthChart.destroy();
            }
            
            const data = {
                labels: ['睡眠', '运动', '营养', '肠道健康', '压力管理'],
                datasets: [{
                    label: '健康得分',
                    data: [
                        pillarPercentages.sleep,
                        pillarPercentages.exercise,
                        pillarPercentages.nutrition,
                        pillarPercentages.gut,
                        pillarPercentages.stress
                    ],
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(102, 126, 234, 1)',
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            };
            
            const config = {
                type: 'radar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            min: 0,
                            ticks: {
                                stepSize: 20,
                                font: {
                                    size: 12
                                },
                                color: '#6b7280'
                            },
                            grid: {
                                color: '#e5e7eb'
                            },
                            angleLines: {
                                color: '#e5e7eb'
                            },
                            pointLabels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#374151'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.r + '%';
                                }
                            }
                        }
                    }
                }
            };
            
            window.healthChart = new Chart(ctx, config);
        }
        
        // 显示结果
        function showResults() {
            const results = calculateResults();
            
            // 保存结果到本地存储
            const savedReports = JSON.parse(localStorage.getItem('healthReports') || '[]');
            savedReports.push(results);
            localStorage.setItem('healthReports', JSON.stringify(savedReports));
            
            // 切换到结果页面
            document.getElementById('questionnairePage').classList.add('hidden');
            document.getElementById('resultsPage').classList.remove('hidden');
            
            // 显示总体得分
            document.getElementById('overallScore').textContent = results.overallHealthPercentage + '%';
            
            // 显示健康等级
            const healthLevelElement = document.getElementById('healthLevel');
            healthLevelElement.textContent = results.healthLevel;
            
            // 设置健康等级颜色
            const levelColors = {
                '状态极佳': '#10b981',
                '状态良好': '#3b82f6',
                '待改善': '#f59e0b',
                '警报状态': '#ef4444',
                '急需干预': '#dc2626'
            };
            healthLevelElement.style.backgroundColor = levelColors[results.healthLevel] || '#6b7280';
            healthLevelElement.style.color = 'white';
            
            // 显示各支柱得分
            const pillarScoresContainer = document.getElementById('pillarScores');
            const pillarNames = {
                sleep: '睡眠',
                exercise: '运动',
                nutrition: '营养',
                gut: '肠道健康',
                stress: '压力管理'
            };
            
            let pillarHTML = '';
            Object.keys(results.pillarPercentages).forEach(pillar => {
                const percentage = results.pillarPercentages[pillar];
                const score = results.pillarScores[pillar];
                const maxScore = results.maxScores[pillar];
                
                pillarHTML += `
                    <div class="pillar-card">
                        <div class="pillar-name">${pillarNames[pillar]}</div>
                        <div class="pillar-score">${score}/${maxScore}分 (${percentage}%)</div>
                    </div>
                `;
            });
            pillarScoresContainer.innerHTML = pillarHTML;
            
            // 创建雷达图
            createRadarChart(results.pillarPercentages);
            
            // 显示建议
            const recommendationsContainer = document.getElementById('recommendations');
            let recommendationsHTML = '<h3>个性化改善建议</h3>';
            results.recommendations.forEach(rec => {
                recommendationsHTML += `
                    <div class="recommendation-item">
                        <div class="recommendation-title">${rec.title}</div>
                        <div>${rec.content}</div>
                    </div>
                `;
            });
            recommendationsContainer.innerHTML = recommendationsHTML;
            
            updateProgress();
        }

        // 导出PDF
        function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // 设置中文字体（使用系统默认字体）
                doc.setFont('helvetica');
                
                // 添加标题
                doc.setFontSize(20);
                doc.text('Health Assessment Report', 20, 30);
                
                // 添加基本信息
                doc.setFontSize(12);
                const basicInfo = answers.basicInfo;
                doc.text(`Birth Year: ${basicInfo.birthYear}`, 20, 50);
                doc.text(`Age: ${basicInfo.age}`, 20, 60);
                doc.text(`Gender: ${basicInfo.gender}`, 20, 70);
                doc.text(`Location: ${basicInfo.province} ${basicInfo.city}`, 20, 80);
                doc.text(`Occupation: ${basicInfo.occupation}`, 20, 90);
                doc.text(`Marital Status: ${basicInfo.maritalStatus}`, 20, 100);
                
                // 添加评估结果
                const results = calculateResults();
                doc.text(`Overall Health: ${results.overallHealthPercentage}%`, 20, 120);
                doc.text(`Health Level: ${results.healthLevel}`, 20, 130);
                
                // 添加各支柱得分
                let yPos = 150;
                doc.text('Pillar Scores:', 20, yPos);
                yPos += 10;
                
                const pillarNames = {
                    sleep: 'Sleep',
                    exercise: 'Exercise', 
                    nutrition: 'Nutrition',
                    gut: 'Gut Health',
                    stress: 'Stress Management'
                };
                
                Object.keys(results.pillarScores).forEach(pillar => {
                    const score = results.pillarScores[pillar];
                    const maxScore = results.maxScores[pillar];
                    const percentage = results.pillarPercentages[pillar];
                    doc.text(`${pillarNames[pillar]}: ${score}/${maxScore} (${percentage}%)`, 30, yPos);
                    yPos += 10;
                });
                
                // 保存PDF
                doc.save(`health-assessment-${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('PDF export failed:', error);
                alert('PDF导出失败，将为您导出JSON格式的数据');
                exportToJSON();
            }
        }

        // 导出JSON
        function exportToJSON() {
            const results = calculateResults();
            const dataStr = JSON.stringify(results, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `health-assessment-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // 重新测试
        function restartTest() {
            if (confirm('确定要重新开始测试吗？当前的答案将会丢失。')) {
                // 重置所有变量
                currentQuestionGlobalIndex = 0;
                answers = {};
                
                // 重置页面显示
                document.getElementById('resultsPage').classList.add('hidden');
                document.getElementById('questionnairePage').classList.add('hidden');
                document.getElementById('basicInfoPage').classList.remove('hidden');
                
                // 清空基本信息表单
                document.getElementById('birth-year').value = '';
                document.getElementById('gender').value = '';
                document.getElementById('province').value = '';
                document.getElementById('city').value = '';
                document.getElementById('occupation').value = '';
                document.getElementById('marital-status').value = '';
                
                // 重置城市选项
                document.getElementById('city').innerHTML = '<option value="">请先选择省份</option>';
                
                updateProgress();
            }
        }
    </script>
</body>
</html>
